services:
  # Secure LDAP profile
  nifi-ldap:
    image: apache/nifi:${NIFI_VERSION}
    container_name: nifi-ldap
    hostname: nifi-ldap
    profiles: ["secure-ldap"]
    ports:
      - "9444:8443"
    volumes:
      - ../certs:/certs:ro
    networks: [nipynet]
    env_file:
      - ../certs/nifi.env
    environment:
      - AUTH=ldap
      # Provide TLS keystore/truststore for secure.sh
      - KEYSTORE_PATH=/certs/nifi/keystore.p12
      - KEYSTORE_TYPE=PKCS12
      - KEYSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - TRUSTSTORE_PATH=/certs/truststore/truststore.p12
      - TRUSTSTORE_TYPE=PKCS12
      - TRUSTSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - INITIAL_ADMIN_IDENTITY=einstein
      - LDAP_AUTHENTICATION_STRATEGY=SIMPLE
      - LDAP_MANAGER_DN=cn=read-only-admin,dc=example,dc=com
      - LDAP_MANAGER_PASSWORD=password
      - LDAP_USER_SEARCH_BASE=dc=example,dc=com
      - LDAP_USER_SEARCH_FILTER=(uid={0})
      - LDAP_IDENTITY_STRATEGY=USE_USERNAME
      - LDAP_URL=ldap://ldap.forumsys.com:389
      - NIFI_WEB_PROXY_HOST=localhost:9444,localhost:8443

  registry-ldap:
    image: apache/nifi-registry:${NIFI_VERSION}
    container_name: registry-ldap
    hostname: registry-ldap
    profiles: ["secure-ldap"]
    ports:
      - "18444:18443"
    volumes:
      - ../certs:/certs:ro
    networks: [nipynet]
    env_file:
      - ../certs/registry.env
    environment:
      - NIFI_REGISTRY_WEB_HTTPS_PORT=18443
      - AUTH=ldap
      # Provide TLS keystore/truststore for secure.sh
      - KEYSTORE_PATH=/certs/registry/keystore.p12
      - KEYSTORE_TYPE=PKCS12
      - KEYSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - TRUSTSTORE_PATH=/certs/truststore/truststore.p12
      - TRUSTSTORE_TYPE=PKCS12
      - TRUSTSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - INITIAL_ADMIN_IDENTITY=einstein
      - LDAP_AUTHENTICATION_STRATEGY=SIMPLE
      - LDAP_MANAGER_DN=cn=read-only-admin,dc=example,dc=com
      - LDAP_MANAGER_PASSWORD=password
      - LDAP_USER_SEARCH_BASE=dc=example,dc=com
      - LDAP_USER_SEARCH_FILTER=(uid={0})
      - LDAP_IDENTITY_STRATEGY=USE_USERNAME
      - LDAP_URL=ldap://ldap.forumsys.com:389

  # Secure mTLS profile
  nifi-mtls:
    image: apache/nifi:${NIFI_VERSION}
    container_name: nifi-mtls
    hostname: nifi-mtls
    profiles: ["secure-mtls"]
    ports:
      - "9445:8443"
    volumes:
      - ../certs:/certs:ro
    env_file:
      - ../certs/nifi.env
    environment:
      - AUTH=tls
      # Provide TLS keystore/truststore for secure.sh (two-way SSL)
      - KEYSTORE_PATH=/certs/nifi/keystore.p12
      - KEYSTORE_TYPE=PKCS12
      - KEYSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - TRUSTSTORE_PATH=/certs/truststore/truststore.p12
      - TRUSTSTORE_TYPE=PKCS12
      - TRUSTSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - INITIAL_ADMIN_IDENTITY=C=US, O=NiPyAPI, CN=user1
      - NIFI_WEB_PROXY_HOST=localhost:9445,localhost:8443
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_SECURITY_NEEDCLIENTAUTH=true
      - NIFI_SECURITY_USER_AUTHORIZER=managed-authorizer
      - NIFI_SECURITY_USER_LOGIN_IDENTITY_PROVIDER=
      - NIFI_SECURITY_ALLOW_ANONYMOUS_AUTHENTICATION=false
    networks: [nipynet]

  registry-mtls:
    image: apache/nifi-registry:${NIFI_VERSION}
    container_name: registry-mtls
    hostname: registry-mtls
    profiles: ["secure-mtls"]
    ports:
      - "18445:18443"
    volumes:
      - ../certs:/certs:ro
    env_file:
      - ../certs/registry.env
    environment:
      - AUTH=tls
      # Provide TLS keystore/truststore for secure.sh (two-way SSL)
      - KEYSTORE_PATH=/certs/registry/keystore.p12
      - KEYSTORE_TYPE=PKCS12
      - KEYSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - TRUSTSTORE_PATH=/certs/truststore/truststore.p12
      - TRUSTSTORE_TYPE=PKCS12
      - TRUSTSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - INITIAL_ADMIN_IDENTITY=C=US, O=NiPyAPI, CN=user1
      - NIFI_REGISTRY_WEB_HTTPS_PORT=18443
      - NIFI_REGISTRY_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_REGISTRY_SECURITY_NEEDCLIENTAUTH=true
      - NIFI_REGISTRY_SECURITY_USER_AUTHORIZER=managed-authorizer
      - NIFI_REGISTRY_SECURITY_IDENTITY_PROVIDER=
      - NIFI_REGISTRY_SECURITY_ALLOW_ANONYMOUS_AUTHENTICATION=false
    networks: [nipynet]

  # Secure single-user (basic credentials) profile
  nifi-single:
    image: apache/nifi:${NIFI_VERSION}
    container_name: nifi-single
    hostname: nifi-single
    profiles: ["single-user"]
    ports:
      - "9443:8443"
    volumes:
      - ../certs:/certs:ro
    env_file:
      - ../certs/nifi.env
    environment:
      - AUTH=tls
      # Map generic TLS vars consumed by /opt/nifi/scripts/secure.sh
      - KEYSTORE_PATH=/certs/nifi/keystore.p12
      - KEYSTORE_TYPE=PKCS12
      - KEYSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - TRUSTSTORE_PATH=/certs/truststore/truststore.p12
      - TRUSTSTORE_TYPE=PKCS12
      - TRUSTSTORE_PASSWORD=${CERT_PASSWORD:-changeit}
      - SINGLE_USER_CREDENTIALS_USERNAME=einstein
      - SINGLE_USER_CREDENTIALS_PASSWORD=password1234
      # Ensure single-user auth remains active under TLS
      - NIFI_SECURITY_USER_AUTHORIZER=single-user-authorizer
      - NIFI_SECURITY_USER_LOGIN_IDENTITY_PROVIDER=single-user-provider
      - NIFI_WEB_HTTPS_PORT=8443
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_WEB_PROXY_HOST=localhost:9443,localhost:8443
    networks: [nipynet]

  registry-single:
    image: apache/nifi-registry:${NIFI_VERSION}
    container_name: registry-single
    hostname: registry-single
    profiles: ["single-user"]
    ports:
      - "18080:18080"
    volumes:
      - ../certs:/certs:ro
    # No TLS env needed for single-user; default HTTP
    environment:
      - SINGLE_USER_CREDENTIALS_USERNAME=einstein
      - SINGLE_USER_CREDENTIALS_PASSWORD=password
      # Defaults to HTTP on 18080 in single-user mode
    networks: [nipynet]
networks:
  nipynet:
    driver: bridge

