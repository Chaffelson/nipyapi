"""
    Apache NiFi REST API

    REST API definition for Apache NiFi web services  # noqa: E501

    OpenAPI spec version: 2.3.0
    Contact: dev@nifi.apache.org
    Generated by: https://github.com/swagger-api/swagger-codegen.git
"""

import logging
import ssl
from typing import Dict, List, Optional, Any, Union, Tuple
import httpx
from urllib.parse import urlencode

from .exceptions import ApiException, ApiValueError

logger = logging.getLogger(__name__)

class RESTClientObject(object):
    """A REST client for making HTTP requests using httpx"""

    def __init__(
        self,
        configuration,
        pools_size: int = 4,
        maxsize: int = None,
        timeout: Optional[float] = None,
        verify_ssl: bool = True,
        ssl_context: Optional[ssl.SSLContext] = None,
        proxy: Optional[str] = None,
    ):
        """Initialize the REST client

        Args:
            configuration: Configuration object
            pools_size: Number of connection pools
            maxsize: Maximum number of connections per pool
            timeout: Request timeout in seconds
            verify_ssl: Whether to verify SSL certificates
            ssl_context: SSL context for HTTPS connections
            proxy: Proxy URL if needed
        """
        self.configuration = configuration
        self.pools_size = pools_size
        self.maxsize = maxsize
        self.timeout = timeout
        self.verify_ssl = verify_ssl
        self.ssl_context = ssl_context
        self.proxy = proxy

        # Initialize the httpx client
        self.client = httpx.Client(
            verify=verify_ssl,
            timeout=timeout,
            proxies=proxy,
            limits=httpx.Limits(max_keepalive_connections=pools_size, max_connections=maxsize),
            trust_env=False,
        )

    async def request(
        self,
        method: str,
        url: str,
        headers: Optional[Dict[str, str]] = None,
        query_params: Optional[List[Tuple[str, str]]] = None,
        body: Optional[Any] = None,
        post_params: Optional[List[Tuple[str, Any]]] = None,
        files: Optional[Dict[str, Any]] = None,
        response_type: Optional[str] = None,
        auth_settings: Optional[List[str]] = None,
        _return_http_data_only: bool = False,
        _preload_content: bool = True,
        _request_timeout: Optional[Union[int, float, Tuple[int, int]]] = None,
    ) -> Tuple[Any, int, Dict[str, str]]:
        """Make an HTTP request using httpx

        Args:
            method: HTTP method (GET, POST, etc.)
            url: URL to request
            headers: HTTP headers
            query_params: Query parameters
            body: Request body
            post_params: POST parameters
            files: Files to upload
            response_type: Expected response type
            auth_settings: Authentication settings
            _return_http_data_only: Whether to return only the response data
            _preload_content: Whether to preload the response content
            _request_timeout: Request timeout

        Returns:
            Tuple of (response data, status code, headers)

        Raises:
            ApiException: If the request fails
        """
        try:
            # Build URL with query parameters
            if query_params:
                url += '?' + urlencode(query_params)

            # Prepare headers
            headers = headers or {}
            if self.configuration.username and self.configuration.password:
                auth = httpx.BasicAuth(self.configuration.username, self.configuration.password)
            else:
                auth = None

            # Make the request
            response = await self.client.request(
                method=method,
                url=url,
                headers=headers,
                auth=auth,
                json=body,
                data=post_params,
                files=files,
                timeout=_request_timeout,
            )

            # Handle response
            if not _preload_content:
                return response, response.status_code, response.headers

            data = response.json() if response.headers.get('content-type') == 'application/json' else response.text

            if not _return_http_data_only:
                return data, response.status_code, response.headers

            return data

        except httpx.HTTPError as e:
            logger.error(f"HTTP request failed: {e}")
            raise ApiException(status=0, reason=str(e))

    async def close(self):
        """Close the httpx client"""
        await self.client.aclose() 