import logging
import ssl
from typing import Dict, List, Optional, Any, Union
from urllib.parse import urlparse

from .exceptions import ApiValueError

logger = logging.getLogger(__name__)

class Configuration:
    """Configuration for API client"""

    def __init__(
        self,
        host: str = "http://localhost:8080",
        api_key: Optional[Dict[str, str]] = None,
        api_key_prefix: Optional[Dict[str, str]] = None,
        username: Optional[str] = None,
        password: Optional[str] = None,
        access_token: Optional[str] = None,
        verify_ssl: bool = True,
        ssl_ca_cert: Optional[str] = None,
        cert_file: Optional[str] = None,
        key_file: Optional[str] = None,
        proxy: Optional[str] = None,
        proxy_headers: Optional[Dict[str, str]] = None,
        timeout: Optional[float] = None,
        retries: Optional[int] = None,
        retry_backoff_factor: float = 0.3,
        retry_status_codes: List[int] = None,
    ):
        """Initialize the configuration

        Args:
            host: Base URL for the API
            api_key: API key for authentication
            api_key_prefix: API key prefix
            username: Username for basic auth
            password: Password for basic auth
            access_token: Access token for OAuth
            verify_ssl: Whether to verify SSL certificates
            ssl_ca_cert: Path to CA certificate file
            cert_file: Path to client certificate file
            key_file: Path to client key file
            proxy: Proxy URL
            proxy_headers: Headers for proxy requests
            timeout: Request timeout in seconds
            retries: Number of retries for failed requests
            retry_backoff_factor: Backoff factor for retries
            retry_status_codes: HTTP status codes to retry on
        """
        self.host = host
        self.api_key = api_key or {}
        self.api_key_prefix = api_key_prefix or {}
        self.username = username
        self.password = password
        self.access_token = access_token
        self.verify_ssl = verify_ssl
        self.ssl_ca_cert = ssl_ca_cert
        self.cert_file = cert_file
        self.key_file = key_file
        self.proxy = proxy
        self.proxy_headers = proxy_headers or {}
        self.timeout = timeout
        self.retries = retries
        self.retry_backoff_factor = retry_backoff_factor
        self.retry_status_codes = retry_status_codes or [408, 429, 500, 502, 503, 504]

        # Validate configuration
        self._validate()

    def _validate(self) -> None:
        """Validate the configuration"""
        if not self.host:
            raise ApiValueError("Host must be set")

        if self.verify_ssl and self.ssl_ca_cert and not self.ssl_ca_cert.startswith('/'):
            raise ApiValueError("SSL CA certificate path must be absolute")

        if self.cert_file and not self.cert_file.startswith('/'):
            raise ApiValueError("Client certificate path must be absolute")

        if self.key_file and not self.key_file.startswith('/'):
            raise ApiValueError("Client key path must be absolute")

        if self.proxy:
            try:
                parsed = urlparse(self.proxy)
                if not all([parsed.scheme, parsed.netloc]):
                    raise ApiValueError("Invalid proxy URL")
            except Exception as e:
                raise ApiValueError(f"Invalid proxy URL: {e}")

    def get_api_key_with_prefix(self, identifier: str) -> str:
        """Get API key with prefix

        Args:
            identifier: API key identifier

        Returns:
            API key with prefix
        """
        if identifier in self.api_key:
            prefix = self.api_key_prefix.get(identifier)
            if prefix:
                return f"{prefix} {self.api_key[identifier]}"
            return self.api_key[identifier]
        return None

    def get_basic_auth_token(self) -> str:
        """Get basic auth token

        Returns:
            Basic auth token
        """
        if self.username and self.password:
            import base64
            token = base64.b64encode(f"{self.username}:{self.password}".encode()).decode()
            return f"Basic {token}"
        return None

    def auth_settings(self) -> Dict[str, Dict[str, str]]:
        """Get authentication settings

        Returns:
            Dictionary of authentication settings
        """
        auth = {}
        if self.username and self.password:
            auth['basicAuth'] = {
                'type': 'basic',
                'in': 'header',
                'key': 'Authorization',
                'value': self.get_basic_auth_token()
            }
        if self.access_token:
            auth['bearerAuth'] = {
                'type': 'bearer',
                'in': 'header',
                'key': 'Authorization',
                'value': f"Bearer {self.access_token}"
            }
        for key, value in self.api_key.items():
            auth[f'apiKeyAuth_{key}'] = {
                'type': 'apiKey',
                'in': 'header',
                'key': key,
                'value': self.get_api_key_with_prefix(key)
            }
        return auth

    def get_ssl_context(self) -> Optional[ssl.SSLContext]:
        """Get SSL context

        Returns:
            SSL context if configured
        """
        if not self.verify_ssl:
            return None

        context = ssl.create_default_context()
        if self.ssl_ca_cert:
            context.load_verify_locations(cafile=self.ssl_ca_cert)
        if self.cert_file and self.key_file:
            context.load_cert_chain(certfile=self.cert_file, keyfile=self.key_file)
        return context 