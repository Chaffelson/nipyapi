"""
Bulletin management for Apache NiFi.

Provides functions for retrieving and clearing bulletins from NiFi components.
Clearing bulletins requires NiFi 2.7.0 or later.

Bulletins are alerts generated by NiFi components when they encounter errors,
warnings, or other notable conditions. They automatically expire after 5 minutes
by default, but can be manually cleared using the functions in this module.

Each bulletin contains:
    - level: Severity (INFO, WARN, ERROR)
    - message: Human-readable description
    - timestamp/timestamp_iso: When the bulletin was generated
    - source_id/source_name: The component that generated it
    - stack_trace: Full Java stack trace for errors (NiFi 2.7.0+)
"""

import nipyapi
from nipyapi.utils import enforce_min_ver, format_timestamp

__all__ = [
    # Retrieval
    "get_bulletins",
    "get_bulletin_board",
    # Clearing (NiFi 2.7.0+)
    "clear_processor_bulletins",
    "clear_process_group_bulletins",
    "clear_controller_service_bulletins",
    "clear_input_port_bulletins",
    "clear_output_port_bulletins",
    "clear_remote_process_group_bulletins",
    "clear_reporting_task_bulletins",
    "clear_parameter_provider_bulletins",
    "clear_registry_client_bulletins",
    "clear_flow_analysis_rule_bulletins",
    # High-level helpers
    "clear_all_bulletins",
]


# --- Retrieval functions ---


def get_bulletins():
    """
    Retrieve current controller-level bulletins.

    Returns system-wide bulletins including those from the flow controller,
    reporting tasks, and controller services at the controller level.

    Returns:
        ControllerBulletinsEntity: Controller bulletins with nested bulletin lists.

    Note:
        Unlike component bulletins, flow controller bulletins (FLOW_CONTROLLER
        source type) cannot be cleared via API. They expire automatically after
        5 minutes per NiFi's default bulletin retention settings.

    Example::

        >>> bulletins = nipyapi.bulletins.get_bulletins()
        >>> for b in bulletins.bulletins or []:
        ...     print(f"{b.bulletin.level}: {b.bulletin.message}")
    """
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.FlowApi().get_bulletins()


def get_bulletin_board(pg_id=None, source_name=None, message=None, limit=None):
    """
    Retrieve bulletins from the bulletin board with optional filtering.

    The bulletin board provides a unified view of bulletins across all
    components in the flow.

    Args:
        pg_id (str, optional): Filter to bulletins from this process group ID.
            If None, returns bulletins from all groups.
        source_name (str, optional): Filter by source component name (regex).
        message (str, optional): Filter by message content (regex).
        limit (int, optional): Maximum number of bulletins to return.

    Returns:
        list[BulletinDTO]: List of bulletin objects with direct field access.
            Returns empty list if no bulletins match.

            Each bulletin has these fields:
                - id (int): Unique bulletin identifier
                - level (str): Severity - 'INFO', 'WARN', or 'ERROR'
                - message (str): Human-readable description
                - category (str): Bulletin category
                - source_id (str): ID of the component that generated it
                - source_name (str): Name of the source component
                - source_type (str): Type of source (e.g., 'PROCESSOR')
                - group_id (str): Parent process group ID
                - timestamp (str): When the bulletin was generated
                - timestamp_iso (str): ISO 8601 formatted timestamp
                - node_address (str): Cluster node address (if clustered)
                - stack_trace (str): Java stack trace for errors (NiFi 2.7.0+)

    Example::

        >>> bulletins = nipyapi.bulletins.get_bulletin_board(pg_id="abc-123")
        >>> for b in bulletins:
        ...     print(f"{b.source_name}: {b.message}")
        ...     if b.stack_trace:
        ...         print(f"  Stack: {b.stack_trace[:100]}...")
    """
    kwargs = {}
    if pg_id is not None:
        kwargs["group_id"] = pg_id
    if source_name is not None:
        kwargs["source_name"] = source_name
    if message is not None:
        kwargs["message"] = message
    if limit is not None:
        kwargs["limit"] = limit

    with nipyapi.utils.rest_exceptions():
        result = nipyapi.nifi.FlowApi().get_bulletin_board(**kwargs)
        entities = result.bulletin_board.bulletins or []
        # Return the DTO directly for cleaner access (bulletin.message vs bulletin.bulletin.message)
        return [e.bulletin for e in entities if e.bulletin]


# --- Clearing functions (NiFi 2.7.0+) ---


def clear_processor_bulletins(processor_id, before=None):
    """
    Clear bulletins for a processor.

    Clears all bulletins with timestamp <= before.

    Args:
        processor_id (str): The processor ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0

    Example::

        >>> # Clear all bulletins for a processor
        >>> nipyapi.bulletins.clear_processor_bulletins(proc.id)
        >>> # Clear bulletins before a specific time
        >>> nipyapi.bulletins.clear_processor_bulletins(
        ...     proc.id, before="2025-01-01T00:00:00.000Z"
        ... )
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.ProcessorsApi().clear_bulletins5(body=request, id=processor_id)


def clear_controller_service_bulletins(service_id, before=None):
    """
    Clear bulletins for a controller service.

    Clears all bulletins with timestamp <= before.

    Args:
        service_id (str): The controller service ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.ControllerServicesApi().clear_bulletins(body=request, id=service_id)


def clear_input_port_bulletins(port_id, before=None):
    """
    Clear bulletins for an input port.

    Clears all bulletins with timestamp <= before.

    Args:
        port_id (str): The input port ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.InputPortsApi().clear_bulletins2(body=request, id=port_id)


def clear_output_port_bulletins(port_id, before=None):
    """
    Clear bulletins for an output port.

    Clears all bulletins with timestamp <= before.

    Args:
        port_id (str): The output port ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.OutputPortsApi().clear_bulletins3(body=request, id=port_id)


def clear_remote_process_group_bulletins(rpg_id, before=None):
    """
    Clear bulletins for a remote process group.

    Clears all bulletins with timestamp <= before.

    Args:
        rpg_id (str): The remote process group ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.RemoteProcessGroupsApi().clear_bulletins6(body=request, id=rpg_id)


def clear_reporting_task_bulletins(task_id, before=None):
    """
    Clear bulletins for a reporting task.

    Clears all bulletins with timestamp <= before.

    Args:
        task_id (str): The reporting task ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.ReportingTasksApi().clear_bulletins7(body=request, id=task_id)


def clear_parameter_provider_bulletins(provider_id, before=None):
    """
    Clear bulletins for a parameter provider.

    Clears all bulletins with timestamp <= before.

    Args:
        provider_id (str): The parameter provider ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.ParameterProvidersApi().clear_bulletins4(body=request, id=provider_id)


def clear_registry_client_bulletins(client_id, before=None):
    """
    Clear bulletins for a registry client.

    Clears all bulletins with timestamp <= before.

    Args:
        client_id (str): The registry client ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.ControllerApi().clear_registry_client_bulletins(
            body=request, id=client_id
        )


def clear_flow_analysis_rule_bulletins(rule_id, before=None):
    """
    Clear bulletins for a flow analysis rule.

    Clears all bulletins with timestamp <= before.

    Args:
        rule_id (str): The flow analysis rule ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        ClearBulletinsResultEntity: Result of the clear operation.

    Raises:
        VersionError: If NiFi version < 2.7.0
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsRequestEntity(from_timestamp=format_timestamp(before))
    with nipyapi.utils.rest_exceptions():
        return nipyapi.nifi.ControllerApi().clear_flow_analysis_rule_bulletins(
            body=request, id=rule_id
        )


def clear_process_group_bulletins(pg_id, before=None, component_ids=None):
    """
    Clear bulletins for a process group and its descendants.

    This cascades to all processors, ports, and other components within the
    process group hierarchy unless specific component_ids are provided.

    Args:
        pg_id (str): The process group ID.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).
        component_ids (list[str], optional): Specific component IDs to clear.
            If not provided, all components in the hierarchy are included.

    Returns:
        ClearBulletinsForGroupResultsEntity: Result with per-component details,
            or None if the process group has no components.

    Raises:
        VersionError: If NiFi version < 2.7.0

    Note:
        This clears bulletins for processors, ports, and nested process groups
        but does NOT clear controller service bulletins. Use clear_all_bulletins()
        for comprehensive clearing including controller services.

        The NiFi API returns an error when clearing bulletins from an empty
        process group (one with no components). This function handles that
        case gracefully by returning None.

    Example::

        >>> # Clear all bulletins in a process group hierarchy
        >>> nipyapi.bulletins.clear_process_group_bulletins(pg.id)
        >>> # Clear only specific components
        >>> nipyapi.bulletins.clear_process_group_bulletins(
        ...     pg.id, component_ids=[proc1.id, proc2.id]
        ... )
    """
    enforce_min_ver("2.7.0")
    request = nipyapi.nifi.ClearBulletinsForGroupRequestEntity(
        from_timestamp=format_timestamp(before), id=pg_id, components=component_ids
    )
    try:
        return nipyapi.nifi.FlowApi().clear_bulletins1(body=request, id=pg_id)
    except nipyapi.nifi.rest.ApiException as e:
        # NiFi returns 400 when the PG has no components to clear
        if e.status == 400 and "Component IDs must be specified" in str(e.body):
            return None
        raise


# --- High-level helpers ---


def clear_all_bulletins(pg_id=None, before=None):
    """
    Clear all bulletins from a process group and its controller services.

    Args:
        pg_id (str, optional): The process group ID. Defaults to root.
        before (str|datetime, optional): Clear bulletins up to and including
            this timestamp. Defaults to current time (clears all).

    Returns:
        int: Total number of bulletins cleared.

    Raises:
        VersionError: If NiFi version < 2.7.0

    Note:
        Controller services are cleared separately as they are not included
        in the process group clear API (may be fixed in future NiFi versions).
        FLOW_CONTROLLER bulletins cannot be cleared via API.

    Example::

        >>> cleared = nipyapi.bulletins.clear_all_bulletins()
        >>> print(f"Cleared {cleared} bulletins")
    """
    enforce_min_ver("2.7.0")

    if pg_id is None:
        pg_id = nipyapi.canvas.get_root_pg_id()

    ts = format_timestamp(before)
    total_cleared = 0

    # Clear all component bulletins in the PG hierarchy
    pg_result = clear_process_group_bulletins(pg_id, before=ts)
    if pg_result:
        total_cleared += pg_result.bulletins_cleared

    # Clear controller services separately (not included in PG clear)
    try:
        for cs in nipyapi.canvas.list_all_controllers(pg_id, True):
            try:
                cs_result = clear_controller_service_bulletins(cs.id, before=ts)
                total_cleared += cs_result.bulletins_cleared
            except Exception:  # pylint: disable=broad-exception-caught
                pass
    except Exception:  # pylint: disable=broad-exception-caught
        pass

    return total_cleared
